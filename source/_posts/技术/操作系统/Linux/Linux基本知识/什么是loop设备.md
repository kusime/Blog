---
date: 2021-03-26 20:42:09
updated: 2021-03-26 20:42:09
title: 什么是 loop 设备
index_img: /gallery/2021-08-23-19-18-20.png
tags:
  - Linux

categories:
  - Linux
---

# 什么是 loop 设备？(1)

- loop 设备是一种伪设备，是使用文件来模拟块设备的一种技术，文件模拟成块设备后, 就像一个磁盘或光盘一样使用
- 在使用之前，一个 loop 设备必须要和一个文件进行连接。
- 如果这个文件包含有一个完整的文件系统，那么这个文件就可以像一个磁盘设备一样被 mount 起来
- 之所以叫 loop 设备（回环），其实是从文件系统这一层来考虑的
  - 因为这种被 mount 起来的镜像文件它本身也包含有文件系统，通过 loop 设备把它 mount 起来
  - 它就像是文件系统之上再绕了一圈的文件系统，所以称为 loop。

# 什么是 loop 设备？(2)

- Loop 设备是一种块设备，但是它并不指向硬盘或者光驱，而是指向一个文件块或者另一种块设备。
- 将另外一种文件系统的镜像文件保存到一个文件中，例如 iso 文件
  - 将一个 Loop 设备指向该文件
  - 紧接着就可以通过 mount 挂载该 loop 设备到主文件系统的一个目录下了
  - 我们就可以正常访问该镜像中的内容，就像访问一个文件系统一样。


# loop 设备的使用

## losetup 命令

- Linux losetup 命令用于设置循环设备。
- 循环设备可把文件虚拟成区块设备，籍以模拟整个文件系统，让用户得以将其视为硬盘驱动器，光驱或软驱等设备，并挂入当作目录来使用。

```bash
losetup [-d][-e <加密方式>][-o <平移数目>][循环设备代号][文件]

-d 卸除设备。
-e<加密方式> 启动加密编码。
-o<平移数目> 设置数据平移的数目。

```

## 例子

- 创建文件
- 这里我专门做了个研究
- 使用 C 语言写一个纯文本文件,生成一个恰好为 512Byte 的纯文本文件
- 可以看见写入的都是 Assic 字符 5

![error_loading](/gallery/2021-03-26-23-08-34.png)

- 然后使用 Shell 来让其扩大 100000 倍

![error_loading](/gallery/2021-03-26-23-09-37.png)

- 最后生成的文件为 50MB 左右的文件

![error_loading](/gallery/2021-03-26-23-11-09.png)

- 因为是 512 字节的倍数，所以也相当于做了扇区对其的意思
- 但是不管如何现在只不过是纯文本文件，还不是设备块
- 所以接下来就是 loop 设备的主要概念了
- 使用 losetup 来创建一个回环设备

  - 这个设备等价于我们常见的 /dev/sda1 之类的设备
  - 不过本质上是一个虚拟化的技术

- 创建 loop

![error_loading](/gallery/2021-03-26-23-15-49.png)

- 可以看见回环设备已经被创建了，接下来就是挂载它

![error_loading](/gallery/2021-03-26-23-17-17.png)

- 可以发现上面的报错了，原因就是，创建回环设备不会创建文件系统
- 就好比只是给了你一个文件大小的硬盘，但是文件系统，分区表，分区，等等还需要单独创建
- 到目前为止，那个回环设备内容还是 50MB 左右的 含有 n 多个 5 的纯文本文件
- 接下来就是为其创建文件系统
  - 使用之前的 mkfs.\* 之类的操作
  - 这也体现到了创建回环作用的作用
  - 因为普通的文件是不可以使用mkfs.* 创建文件系统的
- 创建一个 mkfs.ext4

![error_loading](/gallery/2021-03-26-23-21-23.png)

- 接下来就可以正常挂载了

![error_loading](/gallery/2021-03-26-23-22-55.png)

# 总结

- 所以说，回环设备就是让普通的文件可以使用到系统磁盘的接口(系统调用)
- 平常的主要作用就是，虚拟磁盘？保密文件？以及完整的迁移一个文件系统？
