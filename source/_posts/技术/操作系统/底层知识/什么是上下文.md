---
date: 2021-04-13 18:27:12
updated: 2021-04-13 18:27:12
title: 什么是上下文
index_img: /gallery/2021-08-23-20-13-43.png

tags:
  - System

categories:
  - System

---

# 涉及到的东西

- [PCB]

# 什么是上下文

- 进程上下文，意思是可执行程序代码，是进程的重要组成部分。进程上下文实际上是进程执行活动全过程的静态描述。

- 我们把**已执行过的**进程指令和数据**在相关寄存器与堆栈中的内容称为上文**
- 把**正在执行的**指令和数据在寄存器和堆栈中的内容称为**正文**
- **待执行的指令和数据**在寄存器与堆栈中的内容**称为下文**
- **进程上下文包括**计算机系统中与执行该进程**有关的各种寄存器**
- 进程上下文是可以**按照层次规则**组合起来的。例如在 UNIX System V 中，进程上下文由**用户级上下文**，**寄存器上下文**以及**系统级上下文**组成。

## 其他方式的介绍

- context 指的是（进程）运行时所处的环境和自身的状态，可以理解为当时情况的一个快照。
- 更具体来说，就是进程的各个变量和数据，包括所有的寄存器变量、进程打开的文件、内存信息等。

## 上下文的具体内容

- 用户级上下文：正文、数据、用户堆栈以及共享存储区；
- 寄存器上下文：通用寄存器、程序寄存器(IP)、处理器状态寄存器(EFLAGS)、栈指针(ESP)；
- 系统级上下文：进程控制块 task_struct、内存管理信息(mm_struct、vm_area_struct、pgd、pte)、内核栈。

## 什么是上下文切换

- 上下文切换指的是内核（操作系统的核心）在 CPU 上对进程或者线程进行切换。
- 上下文切换过程中的信息被保存在进程控制块（PCB-Process Control Block）中
- 上下文切换的信息会一直被保存在内存中，直到被再次使用

## 概述

- 上下文切换 (context switch) , 其实际含义是任务切换, 或者 CPU 寄存器切换
- 当多任务内核决定运行另外的任务时, 它保存正在运行任务的当前状态, 也就是**CPU 寄存器中的全部内容**
- 这些内容被保存在任务自己的堆栈中, 入栈工作完成后就把下一个将要运行的任务的当前状况从该任务的栈中重新装入 CPU 寄存器
- 并开始下一个任务的运行, 这一过程就是 context switch。

![error_loading](/gallery/2021-04-13-18-52-20.png)

### 切换的流程

- 挂起一个进程，将这个进程在 CPU 中的状态（上下文信息）存储于内存的 PCB 中
- 在 PCB 中检索下一个进程的上下文并将其在 CPU 的寄存器中恢复
- 跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行）并恢复该进程。

### 上下文切换开销

- 在任务间发生切换**需要花费大量的时间**用于处理诸如:保存和恢复寄存器和内存页表、更新内核相关数据结构等操作
- 上下文切换通常是计算密集型的。也就是说, 它需要相当可观的处理器时间
- 每次切换都需要纳秒量级的时间。所以, 上下文切换对系统来说意味着消耗大量的 CPU 时间

![error_loading](/gallery/2021-04-13-18-54-50.png)
